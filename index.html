<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divisi√≥n por una cifra</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #ff9f43;
            --success: #10b981;
            --danger: #ef4444;
            --light-success: #86efac;
            --light-danger: #fca5a5;
            --bg-start: #1a3a5f;
            --bg-end: #0d2340;
            --card-bg: #FFFFFF;
            --text-dark: #1e3a8a;
            --text-medium: #334155;
            --text-light: #6b7280;
            --hint-bg: #e0effc;
            --shadow: 0px 8px 24px rgba(0, 0, 0, 0.1);
            --transition: 180ms ease;
            --final-score-color: #0055e0;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(to bottom, var(--bg-start), var(--bg-end));
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            overflow-x: hidden;
        }
        /* Contenedor principal responsive */
        .container {
            width: 95vw; /* Ocupa el 95% del ancho de la ventana */
            max-width: 1400px; /* L√≠mite para pantallas muy grandes */
            background-color: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin: 0 auto 20px auto; /* Centrado horizontal */
            position: relative;
            z-index: 1;
            box-sizing: border-box;
        }
        h1, h2, h3 {
            margin-bottom: 16px;
            color: var(--text-dark);
            font-weight: 700;
        }
        h1 { font-size: 2.2em; text-align: center; }
        h2 { font-size: 1.6em; }
        h3 { font-size: 1.3em; }
        p {
            margin-bottom: 16px;
            color: var(--text-light);
        }
        .btn {
            display: inline-block;
            padding: 12px 30px;
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition);
            text-align: center;
            min-height: 44px;
            min-width: 44px;
            position: relative;
            z-index: 10;
        }
        .btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }
        .btn-primary { background-color: var(--primary); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
            position: relative;
            z-index: 10;
        }
        .btn-group-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
            position: relative;
            z-index: 10;
        }
        .screen {
            animation: fadeIn 0.5s ease;
            position: relative;
            z-index: 5;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .start-screen {
            text-align: center;
        }
        .hint-card {
            background-color: var(--hint-bg);
            border-radius: 12px;
            padding: 18px;
            margin: 20px auto;
            max-width: 90%;
            color: var(--text-medium);
            font-size: 1em;
        }
        .hint-card span {
            font-weight: 700;
            color: var(--secondary);
        }
        .start-image {
            max-width: 90%;
            margin: 20px auto 0;
            display: block;
            border-radius: 12px;
        }
        .fixed-sound-btn, .fixed-help-btn, .fixed-tables-btn {
            position: fixed;
            top: 20px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid var(--primary);
            border-radius: 50%;
            color: var(--primary);
            cursor: pointer;
            transition: all var(--transition);
            z-index: 1000;
            box-shadow: var(--shadow);
            font-size: 24px;
        }
        .fixed-sound-btn { left: 20px; }
        .fixed-help-btn { right: 20px; }
        .fixed-tables-btn { left: 80px; }
        .fixed-sound-btn:hover, .fixed-help-btn:hover, .fixed-tables-btn:hover {
            background-color: var(--primary);
            color: white;
            transform: scale(1.1);
        }
        .game-header {
            position: relative;
            min-height: 60px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            width: 100%;
        }
        .guide-text {
            color: var(--text-dark);
            font-weight: 700;
            font-size: 1.2em;
            text-align: center;
            margin-top: 10px;
            min-height: 1.8em;
            animation: fadeIn 0.3s ease;
        }
        .progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
            width: 100%;
        }
        .progress-fill {
            height: 100%;
            background-color: var(--secondary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .progress-text {
            text-align: right;
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 8px;
            width: 100%;
        }
        .division-wrapper {
            display: grid;
            align-items: start;
            justify-content: center;
            margin: 25px auto;
            position: relative;
            width: fit-content;
            font-family: 'Courier New', monospace;
            font-size: 1.6rem;
        }
        .digit-box, .answer-box {
            width: 2.8rem;
            height: 2.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .answer-box {
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1.4rem;
            background-color: #f9fafb;
            transition: all 0.3s;
            cursor: pointer;
        }
        .answer-box.current {
            border-color: #a855f7;
            background-color: #faf5ff;
            transform: scale(1.1);
        }
        .answer-box.filled {
            border-color: #4ade80;
            background-color: #f0fdf4;
        }
        .answer-box.correct {
            border-color: var(--success);
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }
        .answer-box.incorrect {
            border-color: var(--danger);
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            animation: shake 0.5s ease;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .digit-bank {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px auto;
            width: 100%;
            max-width: 320px;
        }
        .digit-btn {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--card-bg);
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 22px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
        }
        .digit-btn:hover {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        .question-popup {
            position: relative;
            margin: 40px auto;
            background-color: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 10;
            text-align: center;
            max-width: 90%;
            width: fit-content;
        }
        .question-popup h3 {
            margin-bottom: 15px;
            color: var(--text-dark);
            font-size: 1.1em;
        }
        .feedback {
            margin: 20px 0;
            padding: 18px;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 700;
            text-align: center;
            width: 100%;
            max-width: 500px;
            left: 50%;
            transform: translateX(-50%);
            position: relative;
            display: none;
        }
        .feedback.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }
        .feedback.success {
            background-color: rgba(16, 185, 129, 0.15);
            border: 3px solid var(--success);
            color: var(--success);
        }
        .feedback.error {
            background-color: rgba(239, 68, 68, 0.15);
            border: 3px solid var(--danger);
            color: var(--danger);
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            max-width: 90%;
            width: 320px;
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }
        .unstyled-list p {
            margin-bottom: 10px;
            color: var(--text-medium);
            font-size: 1em;
        }
        .final-screen {
            text-align: center;
        }
        .trophy {
            font-size: 60px;
            margin: 20px 0;
            animation: trophyAnimation 2s ease-in-out infinite;
        }
        @keyframes trophyAnimation {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            50% { transform: scale(1.2) rotate(5deg); }
            75% { transform: scale(1.1) rotate(-5deg); }
        }
        .final-score {
            font-size: 2.8em;
            font-weight: 700;
            color: var(--final-score-color) !important;
            margin: 20px 0;
        }
        .final-time {
            font-size: 18px;
            color: var(--text-light);
            margin-bottom: 20px;
        }
        .final-message {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 20px;
        }
        .credit {
            margin-top: 20px;
            font-size: 12px;
            color: var(--text-light);
        }
        .school-logo {
            max-width: 120px;
            margin: 20px auto;
            display: block;
        }
        /* Improved Confetti */
        .confetti-piece {
            position: absolute;
            opacity: 0;
            animation: confettiRain 4s linear infinite;
        }
        @keyframes confettiRain {
            0% { opacity: 1; top: -10px; transform: rotate(0deg); }
            100% { opacity: 0; top: 100vh; transform: rotate(720deg); }
        }
        .magnitude-highlight {
            color: #ff9f43;
            font-weight: 700;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--text-dark);
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1.1em;
            font-family: 'Poppins', sans-serif;
            text-align: center;
        }
        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .manual-error {
            color: var(--danger);
            font-weight: 700;
            margin-top: 10px;
            text-align: center;
        }
        @media (min-width: 768px) {
            .container { 
                padding: 25px; 
            }
            h1 { font-size: 2.5em; }
            .division-wrapper { font-size: 1.9rem; }
            .digit-box, .answer-box, .divisor-box { width: 3.2rem; height: 3.2rem; }
            .digit-btn { width: 54px; height: 54px; font-size: 24px; }
        }
        @media (min-width: 1024px) {
            .container { 
                padding: 30px; 
            }
            h1 { font-size: 2.8em; }
            .division-wrapper { font-size: 2.1rem; }
            .digit-box, .answer-box, .divisor-box { width: 3.6rem; height: 3.6rem; }
        }
        /* A√±adido para evitar solapamiento del t√≠tulo en m√≥viles */
        @media (max-width: 767px) {
            /* A√±ade espacio superior al contenedor SOLO en la pantalla de juego */
            body > div > div.screen.active > .container {
                padding-top: 80px; /* Altura de los iconos + espacio extra */
            }
            /* Asegura que el h1 dentro del game-header no tenga margen extra que pueda causar problemas */
            .game-header h1 {
                margin-top: 0;
            }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "use-sound": "https://aistudiocdn.com/use-sound@^5.0.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- LOGIC UTILS ---
        
        const calculateMinInteractions = (steps) => {
            let min = 1; // 1 for initial selection ("¬øCu√°ntas cifras...?")
            
            steps.forEach(step => {
                // 1 click for quotient digit
                min += 1; 
                
                if (step.isZeroQuotient) {
                    // Zero Quotient: No remainder subtraction input.
                    // Just bring down digit input if it exists
                    if (step.digitToBringDown !== null) {
                        min += 1;
                    }
                } else {
                    // Normal Step:
                    // Remainder digits (e.g. remainder 5 -> 1 click, 12 -> 2 clicks)
                    min += step.remainder.toString().length;
                    
                    // Bring down digit input if it exists
                    if (step.digitToBringDown !== null) {
                        min += 1;
                    }
                }
            });
            return min;
        };

        const calculateDivisionSteps = (dividendStr, divisor) => {
            const steps = [];
            const dividendDigits = dividendStr.split('').map(Number);
            
            let currentPos = 0;
            let currentPartialStr = "";
            let initialTake = 0;
            let tempVal = 0;
            
            while (currentPos < dividendDigits.length) {
                currentPartialStr += dividendDigits[currentPos];
                tempVal = parseInt(currentPartialStr, 10);
                currentPos++;
                initialTake++;
                
                if (tempVal >= divisor) {
                    break;
                }
            }

            // Edge case
            if (tempVal < divisor && currentPos === dividendDigits.length) {
                steps.push({
                    stepIndex: 0,
                    partialDividend: tempVal,
                    quotientDigit: 0,
                    product: 0,
                    remainder: tempVal,
                    digitToBringDown: null,
                    isZeroQuotient: true,
                    displayString: currentPartialStr
                });
                return steps;
            }

            // Loop
            while (true) {
                const quotientDigit = Math.floor(tempVal / divisor);
                const product = quotientDigit * divisor;
                const remainder = tempVal - product;
                const digitToBringDown = currentPos < dividendDigits.length ? dividendDigits[currentPos].toString() : null;
                const isZeroQuotient = quotientDigit === 0;

                steps.push({
                    stepIndex: steps.length,
                    partialDividend: tempVal,
                    quotientDigit,
                    product,
                    remainder,
                    digitToBringDown,
                    isZeroQuotient,
                    displayString: currentPartialStr
                });

                if (digitToBringDown === null) {
                    break;
                }

                if (isZeroQuotient) {
                    currentPartialStr = tempVal.toString() + digitToBringDown;
                    tempVal = parseInt(currentPartialStr, 10);
                } else {
                    currentPartialStr = remainder.toString() + digitToBringDown;
                    tempVal = parseInt(currentPartialStr, 10);
                }
                
                currentPos++;
            }
            return steps;
        };

        const generateRandomDivision = () => {
            // Updated Logic: Always guarantee 3 digits in quotient.
            // This ensures exactly 2 bring down steps.
            const divisor = Math.floor(Math.random() * 8) + 2; // 2 to 9
            
            // Random Quotient between 100 and 999 (3 digits)
            const quotient = Math.floor(Math.random() * 900) + 100;
            
            const remainder = Math.floor(Math.random() * divisor);
            const dividend = (quotient * divisor + remainder).toString();
            
            // Math proof:
            // If dividend ends up being 3 digits (e.g., 200), then Dividend/Divisor = 100.
            // 200 / 2 = 100. First digit 2 >= 2. Take 1. 
            // If dividend ends up being 4 digits (e.g. 1800), then 1800 / 2 = 900.
            // First digit 1 < 2. Take 2.
            // This satisfies the user requirement automatically by math properties.
            
            return { dividend, divisor };
        };

        // --- HOOKS ---

        const useSound = (url, options = {}) => {
            const { volume = 1, soundEnabled = true } = options;
            const [audio] = React.useState(() => {
                const a = new Audio(url);
                a.volume = volume;
                return a;
            });

            React.useEffect(() => {
                audio.volume = volume;
            }, [volume]);

            const play = () => {
                if (soundEnabled) {
                    audio.currentTime = 0;
                    audio.play().catch(e => console.log("Audio play error", e));
                }
            };
            return [play];
        };

        // --- COMPONENTS ---

        const GridRenderer = ({ dividend, divisor, logicSteps, progress }) => {
            const ddo = dividend;
            const dsr = divisor.toString();
            const qLen = logicSteps.length; 

            const totalCols = ddo.length + 1 + 1 + qLen; 

            const renderElements = () => {
                const elements = [];

                // 1. Dividend Digits
                for (let i = 0; i < ddo.length; i++) {
                    elements.push(
                        <div key={`dd-${i}`} className="digit-box" style={{ gridRow: 1, gridColumn: i + 1 }}>
                            {ddo[i]}
                        </div>
                    );
                }
                // 2. Vertical Line
                elements.push(
                    <div key="vline" style={{
                        gridColumn: ddo.length + 1,
                        gridRow: '1 / 2',
                        borderLeft: '3px solid #1f2937',
                        height: '100%'
                    }} />
                );
                // 3. Divisor
                elements.push(
                    <div key="divisor" className="digit-box" style={{ gridRow: 1, gridColumn: ddo.length + 2 }}>
                        {dsr}
                    </div>
                );
                // 4. Horizontal Line
                elements.push(
                    <div key="hline" style={{
                        gridColumn: `${ddo.length + 1} / span ${1 + qLen}`,
                        gridRow: 2,
                        borderTop: '3px solid #1f2937',
                        height: 0
                    }} />
                );
                // 5. Quotient Boxes
                logicSteps.forEach((step, idx) => {
                    const isPast = idx < progress.currentStepIndex;
                    const isCurrent = idx === progress.currentStepIndex && progress.phase === 'quotient';
                    const hasHistory = progress.quotientHistory[idx] !== undefined;
                    const col = ddo.length + 2 + idx;
                    let content = '';
                    let className = 'answer-box';
                    if (hasHistory) {
                        content = progress.quotientHistory[idx].val.toString();
                        className += ' filled correct';
                    } else if (isCurrent) {
                        className += ' current';
                    }
                    elements.push(
                        <div key={`q-${idx}`} className={className} style={{ gridRow: 3, gridColumn: col }}>
                            {content}
                        </div>
                    );
                });
                // 6. Arc
                if (progress.digitsTaken > 0 && progress.phase !== 'select_digits') {
                    elements.push(
                        <div key="arc" style={{
                            gridRow: 1,
                            gridColumn: `1 / span ${progress.digitsTaken}`,
                            position: 'relative',
                            height: 0
                        }}>
                            <div style={{
                                position: 'absolute',
                                top: '-10px',
                                left: 0,
                                width: '100%',
                                height: '15px',
                                border: '3px solid var(--danger)',
                                borderBottom: 'none',
                                borderRadius: '100% 100% 0 0'
                            }}></div>
                        </div>
                    );
                }
                // 7. Logic Steps
                let currentRow = 3; 
                let currentParcialEndCol = progress.digitsTaken;

                for (let i = 0; i < logicSteps.length; i++) {
                    if (i > progress.currentStepIndex) break;
                    const step = logicSteps[i];
                    const isCurrentStep = i === progress.currentStepIndex;
                    
                    if (step.isZeroQuotient) {
                        const rowToRender = currentRow - 1; 
                        if (step.digitToBringDown !== null) {
                            const show = i < progress.currentStepIndex || (isCurrentStep && progress.phase === 'finished');
                            if (show) {
                                elements.push(
                                    <div key={`bd-${i}`} className="digit-box" style={{ gridRow: rowToRender, gridColumn: currentParcialEndCol + 1 }}>
                                        {step.digitToBringDown}
                                    </div>
                                );
                            }
                            currentParcialEndCol++;
                        }
                    } else {
                        const remainderStr = step.remainder.toString();
                        const startCol = currentParcialEndCol - remainderStr.length + 1;
                        const showRemainder = !isCurrentStep || (isCurrentStep && (progress.phase === 'bring_down' || progress.phase === 'finished'));
                        const isTyping = isCurrentStep && progress.phase === 'multiply_subtract';

                        if (showRemainder) {
                            for (let k = 0; k < remainderStr.length; k++) {
                                elements.push(
                                    <div key={`rem-${i}-${k}`} className="digit-box correct" style={{ gridRow: currentRow, gridColumn: startCol + k }}>
                                        {remainderStr[k]}
                                    </div>
                                );
                            }
                        } else if (isTyping) {
                            const input = progress.tempInput;
                            const inputStart = currentParcialEndCol - input.length + 1;
                            for (let k = 0; k < input.length; k++) {
                                elements.push(
                                    <div key={`temp-${i}-${k}`} className="answer-box current" style={{ gridRow: currentRow, gridColumn: inputStart + k }}>
                                        {input[k]}
                                    </div>
                                );
                            }
                        }

                        if (showRemainder || isTyping) {
                            if (step.digitToBringDown !== null) {
                                const showBD = i < progress.currentStepIndex;
                                if (showBD) {
                                    elements.push(
                                        <div key={`bd-${i}`} className="digit-box" style={{ gridRow: currentRow, gridColumn: currentParcialEndCol + 1 }}>
                                            {step.digitToBringDown}
                                        </div>
                                    );
                                }
                                currentParcialEndCol++;
                            }
                            currentRow++; 
                        }
                    }
                }
                return elements;
            };

            return (
                <div className="division-wrapper" style={{ gridTemplateColumns: `repeat(${totalCols}, 1fr)` }}>
                    {renderElements()}
                </div>
            );
        };

        const GameScreen = ({ config, soundEnabled, setSoundEnabled, onFinishGame, onExit, onNextLevel, onNewManual, onUserInteraction }) => {
            const [logicSteps, setLogicSteps] = React.useState([]);
            const [progress, setProgress] = React.useState({
                digitsTaken: 0,
                currentStepIndex: 0,
                phase: 'select_digits',
                tempInput: '',
                quotientHistory: [],
                gridHistory: []
            });
            const [showQuestionPopup, setShowQuestionPopup] = React.useState(false);
            const [questionText, setQuestionText] = React.useState('');
            const [questionOptions, setQuestionOptions] = React.useState([]);
            const [feedback, setFeedback] = React.useState(null);
            const [showHelp, setShowHelp] = React.useState(false);
            const [showTables, setShowTables] = React.useState(false);

            const [playCorrect] = useSound('https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/7b86808e254100aeaba6285b3e0b82650ae78055/Correcto.mp3', { volume: 0.7, soundEnabled });
            const [playError] = useSound('https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/7b86808e254100aeaba6285b3e0b82650ae78055/Error.mp3', { volume: 0.7, soundEnabled });
            const [playTap] = useSound('https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/37b3eb2da9c15c04dfb71dfe1be60f088ea3cdfc/Tap.mp3', { volume: 0.7, soundEnabled });

            React.useEffect(() => {
                const steps = calculateDivisionSteps(config.dividend, config.divisor);
                setLogicSteps(steps);
                setProgress({
                    digitsTaken: 0,
                    currentStepIndex: 0,
                    phase: 'select_digits',
                    tempInput: '',
                    quotientHistory: [],
                    gridHistory: []
                });
                setFeedback(null);
                setQuestionText('¬øCu√°ntas cifras del dividendo cogemos?');
                setQuestionOptions([1, 2]);
                setShowQuestionPopup(true);
            }, [config]);

            const handleQuestionOptionClick = (opt) => {
                playTap();
                onUserInteraction(); // Track click
                const dividendStr = config.dividend;
                const firstDigit = parseInt(dividendStr[0]);
                let valid = false;
                if (opt === 1 && firstDigit >= config.divisor) valid = true;
                else if (opt === 2 && firstDigit < config.divisor && dividendStr.length >= 2) valid = true;
                else if (opt === 2 && dividendStr.length < 2) valid = false;

                if (valid) {
                    playCorrect();
                    setShowQuestionPopup(false);
                    setProgress(prev => ({ ...prev, digitsTaken: opt, phase: 'quotient' }));
                } else {
                    playError();
                }
            };

            const getGuideText = () => {
                if (progress.phase === 'select_digits') return "0. ¬øCu√°ntas cifras cogemos?";
                if (progress.phase === 'quotient') return "1. Buscar en la tabla un n√∫mero que se acerque sin pasarse";
                if (progress.phase === 'multiply_subtract') return "2. Multiplicar hasta llegar. (Multiplica y resta mentalmente)";
                if (progress.phase === 'bring_down') {
                    const step = logicSteps[progress.currentStepIndex];
                    if (step && step.isZeroQuotient) {
                        return "Recuerda: Cero al cociente, se baja la cifra siguiente.";
                    }
                    return "3. Baja la siguiente cifra.";
                }
                if (progress.phase === 'finished') return "¬°Divisi√≥n terminada! Comprueba tu resultado final.";
                return "";
            };

            const handleDigitClick = (digit) => {
                if (progress.phase === 'finished') return;
                playTap();
                onUserInteraction(); // Track click

                const currentStep = logicSteps[progress.currentStepIndex];

                if (progress.phase === 'quotient') {
                    if (digit === currentStep.quotientDigit) {
                        playCorrect();
                        const newHist = [...progress.quotientHistory];
                        newHist[progress.currentStepIndex] = { val: digit, correct: true };
                        if (currentStep.isZeroQuotient) {
                            if (currentStep.digitToBringDown !== null) {
                                setProgress(prev => ({ ...prev, quotientHistory: newHist, phase: 'bring_down' }));
                            } else {
                                setProgress(prev => ({ ...prev, quotientHistory: newHist, phase: 'finished' }));
                            }
                        } else {
                            setProgress(prev => ({ ...prev, quotientHistory: newHist, phase: 'multiply_subtract', tempInput: '' }));
                        }
                    } else {
                        playError();
                    }
                } else if (progress.phase === 'multiply_subtract') {
                    const expectedStr = currentStep.remainder.toString();
                    const nextInput = progress.tempInput + digit.toString();
                    if (nextInput.length <= expectedStr.length) {
                        setProgress(prev => ({ ...prev, tempInput: nextInput }));
                        if (nextInput.length === expectedStr.length) {
                            if (parseInt(nextInput) === currentStep.remainder) {
                                playCorrect();
                                if (currentStep.digitToBringDown !== null) {
                                    setProgress(prev => ({ ...prev, phase: 'bring_down', tempInput: '' }));
                                } else {
                                    setProgress(prev => ({ ...prev, phase: 'finished', tempInput: '' }));
                                }
                            } else {
                                playError();
                                setTimeout(() => setProgress(prev => ({ ...prev, tempInput: '' })), 500);
                            }
                        }
                    }
                } else if (progress.phase === 'bring_down') {
                    const expected = parseInt(currentStep.digitToBringDown || '0');
                    if (digit === expected) {
                        playCorrect();
                        const nextIdx = progress.currentStepIndex + 1;
                        if (nextIdx < logicSteps.length) {
                            setProgress(prev => ({ ...prev, currentStepIndex: nextIdx, phase: 'quotient' }));
                        } else {
                            setProgress(prev => ({ ...prev, phase: 'finished' }));
                        }
                    } else {
                        playError();
                    }
                }
            };

            const handleCheck = () => {
                playCorrect();
                const quotient = Math.floor(parseInt(config.dividend) / config.divisor);
                const remainder = parseInt(config.dividend) % config.divisor;
                setFeedback({
                    msg: `¬°Correcto! ${config.dividend} √∑ ${config.divisor} = ${quotient} resto ${remainder}`,
                    type: 'success'
                });
            };

            const handleActionBtn = (action) => {
                playTap();
                if (action === 'results') {
                    onFinishGame();
                }
                if (action === 'next') onNextLevel();
                if (action === 'new') onNewManual();
                if (action === 'exit') onExit();
            };

            return (
                <div className="screen active" style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', width: '100%' }}>
                    <button className="fixed-sound-btn" onClick={() => { playTap(); setSoundEnabled(!soundEnabled); }}>
                        {soundEnabled ? 'üîä' : 'üîá'}
                    </button>
                    <button className="fixed-tables-btn" onClick={() => { playTap(); setShowTables(true); }}>üìä</button>
                    <button className="fixed-help-btn" onClick={() => { playTap(); setShowHelp(true); }}>‚ùì</button>

                    <div className="container">
                        <div className="game-header">
                            <h1>Divisi√≥n por una cifra</h1>
                            {!config.isInfinite && !config.isManual && (
                                <>
                                    <div className="progress-text">{config.questionIndex + 1}/{config.totalQuestions}</div>
                                    <div className="progress-bar">
                                        <div className="progress-fill" style={{ width: `${((config.questionIndex + 1) / config.totalQuestions) * 100}%` }}></div>
                                    </div>
                                </>
                            )}
                            <div className="guide-text">{getGuideText()}</div>
                        </div>
                        
                        <div id="divisionArea" style={{ display: 'flex', justifyContent: 'center', marginBottom: '20px' }}>
                            <GridRenderer 
                                dividend={config.dividend}
                                divisor={config.divisor}
                                logicSteps={logicSteps}
                                progress={progress}
                            />
                        </div>
                        
                        {showQuestionPopup && (
                            <div className="question-popup visible">
                                <h3>{questionText}</h3>
                                <div className="digit-bank">
                                    {questionOptions.map(opt => (
                                        <button key={opt} className="digit-btn" onClick={() => handleQuestionOptionClick(opt)}>{opt}</button>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {!showQuestionPopup && progress.phase !== 'finished' && (
                            <div className="digit-bank">
                                {[0,1,2,3,4,5,6,7,8,9].map(d => (
                                    <button key={d} className="digit-btn" onClick={() => handleDigitClick(d)}>{d}</button>
                                ))}
                            </div>
                        )}
                        
                        <div className="btn-group-row">
                            {progress.phase === 'finished' && !feedback && (
                                <button className="btn btn-primary" onClick={handleCheck}>Comprobar</button>
                            )}
                            {feedback && (
                                <>
                                    {config.isInfinite ? (
                                        <>
                                            <button className="btn btn-success" onClick={() => handleActionBtn('next')}>Continuar</button>
                                            <button className="btn btn-danger" onClick={() => handleActionBtn('exit')}>Salir</button>
                                        </>
                                    ) : config.isManual ? (
                                        <>
                                            <button className="btn btn-primary" onClick={() => handleActionBtn('new')}>Nueva</button>
                                            <button className="btn" onClick={() => handleActionBtn('exit')}>Inicio</button>
                                        </>
                                    ) : (
                                        config.questionIndex + 1 < config.totalQuestions ? (
                                            <button className="btn btn-success" onClick={() => handleActionBtn('next')}>Continuar</button>
                                        ) : (
                                            <button className="btn btn-success" onClick={() => handleActionBtn('results')}>Resultados</button>
                                        )
                                    )}
                                </>
                            )}
                        </div>
                        
                        {feedback && (
                            <div className={`feedback show ${feedback.type}`}>
                                {feedback.msg}
                            </div>
                        )}
                    </div>

                    {showHelp && (
                        <div className="modal active" onClick={() => setShowHelp(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2>¬øC√≥mo dividir?</h2>
                                    <button className="modal-close" onClick={() => setShowHelp(false)}>&times;</button>
                                </div>
                                <div className="help-content unstyled-list">
                                    <p><strong>0. ¬øCu√°ntas cifras cogemos?</strong></p>
                                    <p><strong>1. Buscar en la tabla</strong> un n√∫mero que se acerque sin pasarse</p>
                                    <p><strong>2. Multiplicar hasta llegar.</strong> (Multiplica y resta mentalmente)</p>
                                    <p><strong>3. Baja la siguiente cifra.</strong></p>
                                    <p className="magnitude-highlight" style={{ marginTop: '20px', textAlign: 'center' }}>
                                        Recuerda: Cero al cociente, se baja la cifra siguiente.
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}

                    {showTables && (
                        <div className="modal active" onClick={() => setShowTables(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                 <div className="modal-header">
                                    <h2>Tabla del {config.divisor}</h2>
                                    <button className="modal-close" onClick={() => setShowTables(false)}>&times;</button>
                                </div>
                                <div className="tables-content">
                                    {[1,2,3,4,5,6,7,8,9,10].map(n => (
                                        <p key={n}>{config.divisor} x {n} = {config.divisor * n}</p>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Confetti = () => {
            const colors = ['#d946ef', '#ff9f43', '#3b82f6', '#10b981', '#facc15', '#ef4444'];
            return (
                <div style={{ position: 'fixed', top: 0, left: 0, width: '100%', height: '100%', pointerEvents: 'none', zIndex: 9999 }}>
                    {Array.from({ length: 100 }).map((_, i) => {
                        const left = Math.random() * 100;
                        const delay = Math.random() * 3;
                        const color = colors[Math.floor(Math.random() * colors.length)];
                        const size = Math.random() * 8 + 6;
                        const rotation = Math.random() * 360;
                        return (
                            <div 
                                key={i}
                                className="confetti-piece"
                                style={{
                                    left: `${left}%`,
                                    backgroundColor: color,
                                    width: `${size}px`,
                                    height: `${size}px`,
                                    animationDelay: `${delay}s`,
                                    transform: `rotate(${rotation}deg)`
                                }}
                            />
                        );
                    })}
                </div>
            )
        };

        const App = () => {
            const [screen, setScreen] = React.useState('start');
            const [config, setConfig] = React.useState(null);
            const [manualDiv, setManualDiv] = React.useState('');
            const [manualDivisor, setManualDivisor] = React.useState('');
            const [errorMsg, setErrorMsg] = React.useState('');
            const [finalScore, setFinalScore] = React.useState(0);
            const [finalTimeStr, setFinalTimeStr] = React.useState("00:00");
            const [soundEnabled, setSoundEnabled] = React.useState(true);
            
            // Global Scoring State
            const [globalMinInteractions, setGlobalMinInteractions] = React.useState(0);
            const [globalUserInteractions, setGlobalUserInteractions] = React.useState(0);

            const [playTap] = useSound('https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/37b3eb2da9c15c04dfb71dfe1be60f088ea3cdfc/Tap.mp3', { volume: 0.7, soundEnabled });
            const [playError] = useSound('https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/7b86808e254100aeaba6285b3e0b82650ae78055/Error.mp3', { volume: 0.7, soundEnabled });
            const [playVictory] = useSound('https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/7b86808e254100aeaba6285b3e0b82650ae78055/Termin%C3%A9.mp3', { volume: 0.7, soundEnabled });
            const [playCompleted] = useSound('https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/7b86808e254100aeaba6285b3e0b82650ae78055/Completado.mp3', { volume: 0.7, soundEnabled });

            const startGame = (isInfinite) => {
                playTap();
                const { dividend, divisor } = generateRandomDivision();
                const steps = calculateDivisionSteps(dividend, divisor);
                const minInteractions = calculateMinInteractions(steps);
                
                // Reset Score Counters
                setGlobalMinInteractions(minInteractions);
                setGlobalUserInteractions(0);

                setConfig({
                    dividend,
                    divisor,
                    isInfinite,
                    isManual: false,
                    score: 0,
                    questionIndex: 0,
                    totalQuestions: 3,
                    startTime: Date.now(),
                    minInteractions // local min for current question (legacy) but we track global separately
                });
                setScreen('game');
            };

            const showManualMode = () => {
                playTap();
                setManualDiv('');
                setManualDivisor('');
                setErrorMsg('');
                setScreen('manual_setup');
            };

            const startManual = () => {
                playTap();
                const d = parseInt(manualDiv);
                const ds = parseInt(manualDivisor);
                if (isNaN(d) || isNaN(ds) || d < 10 || d > 9999) {
                    setErrorMsg('El dividendo debe estar entre 10 y 9999.');
                    playError();
                    return;
                }
                if (ds < 2 || ds > 9) {
                    setErrorMsg('El divisor debe ser una cifra (2-9).');
                    playError();
                    return;
                }
                const steps = calculateDivisionSteps(manualDiv, ds);
                const minInteractions = calculateMinInteractions(steps);
                
                setGlobalMinInteractions(minInteractions);
                setGlobalUserInteractions(0);

                setConfig({
                    dividend: manualDiv,
                    divisor: ds,
                    isInfinite: false,
                    isManual: true,
                    score: 0,
                    questionIndex: 0,
                    totalQuestions: 1,
                    startTime: Date.now(),
                    minInteractions
                });
                setScreen('game');
            };

            const handleUserInteraction = () => {
                setGlobalUserInteractions(prev => prev + 1);
            };

            const handleFinishGame = () => {
                if (!config) return;
                
                // Final Score Calculation
                let score = 0;
                if (globalUserInteractions > 0) {
                    score = Math.floor((globalMinInteractions / globalUserInteractions) * 100);
                    if (score > 100) score = 100;
                }
                
                const elapsed = Math.floor((Date.now() - config.startTime) / 1000); 
                const minutes = Math.floor(elapsed / 60); 
                const seconds = elapsed % 60; 
                const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                setFinalScore(score);
                setFinalTimeStr(timeStr);
                setScreen('final');
                if (score === 100) {
                    playVictory();
                } else {
                    playCompleted();
                }
            };

            const handleNextLevel = () => {
                if (!config) return;
                
                // Generate next question
                const { dividend, divisor } = generateRandomDivision();
                const steps = calculateDivisionSteps(dividend, divisor);
                const nextMinInteractions = calculateMinInteractions(steps);

                // Accumulate min interactions
                setGlobalMinInteractions(prev => prev + nextMinInteractions);

                if (config.isInfinite) {
                    setConfig({ ...config, dividend, divisor });
                } else {
                    if (config.questionIndex + 1 < config.totalQuestions) {
                        setConfig({ ...config, questionIndex: config.questionIndex + 1, dividend, divisor });
                    } else {
                        // This case shouldn't be reached if button logic is correct (shows Results on last)
                        handleFinishGame(); 
                    }
                }
            };

            return (
                <>
                    {screen === 'start' && (
                        <div className="screen start-screen active">
                            <div className="container">
                                <h1>La divisi√≥n entre una cifra</h1>
                                <p>Practica la <span className="magnitude-highlight">divisi√≥n entre una cifra</span> y aprende jugando</p>
                                <div className="hint-card">
                                    Recuerda que en la <span className="magnitude-highlight">divisi√≥n</span>, vamos <span className="magnitude-highlight">de izquierda a derecha</span>. Si tienes dudas, pulsa el bot√≥n de ayuda. <br/><br/><strong>¬°Buena suerte!</strong>
                                </div>
                                <div className="btn-group">
                                    <button className="btn" onClick={() => startGame(false)}>Comenzar</button>
                                    <button className="btn btn-primary" onClick={showManualMode}>Manual</button>
                                </div>
                                <img src="https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/refs/heads/main/Ni%C3%B1os.png" alt="Ni√±os estudiando" className="start-image"/>
                            </div>
                        </div>
                    )}
                    {screen === 'manual_setup' && (
                        <div className="screen active">
                            <div className="container">
                                <h1>Modo Manual</h1>
                                <p>Introduce tu propia divisi√≥n para practicar.</p>
                                <div className="input-group">
                                    <label htmlFor="manualDividend">Dividendo (entre 10 y 9999)</label>
                                    <input type="number" id="manualDividend" placeholder="Ej: 456" value={manualDiv} onChange={(e) => setManualDiv(e.target.value)} />
                                </div>
                                <div className="input-group">
                                    <label htmlFor="manualDivisor">Divisor (una cifra)</label>
                                    <input type="number" id="manualDivisor" placeholder="Ej: 5" value={manualDivisor} onChange={(e) => setManualDivisor(e.target.value)} />
                                </div>
                                <div className="manual-error">{errorMsg}</div>
                                <div className="btn-group">
                                    <button className="btn btn-success" onClick={startManual}>Empezar</button>
                                    <button className="btn" onClick={() => { playTap(); setScreen('start'); }}>Atr√°s</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {screen === 'game' && config && (
                        <GameScreen 
                            config={config} 
                            soundEnabled={soundEnabled}
                            setSoundEnabled={setSoundEnabled}
                            onExit={() => { playTap(); setScreen('start'); }}
                            onFinishGame={handleFinishGame}
                            onNextLevel={handleNextLevel}
                            onNewManual={showManualMode}
                            onUserInteraction={handleUserInteraction}
                        />
                    )}
                    {screen === 'final' && (
                        <div className="screen final-screen active">
                            <div className="container">
                                <h1>La divisi√≥n entre una cifra</h1>
                                {finalScore === 100 && <div className="trophy">üèÜ</div>}
                                <div className="final-score" style={{ color: 'var(--final-score-color)' }}>{finalScore}</div>
                                <div className="final-time">Tiempo: {finalTimeStr}</div>
                                <p className="final-message">
                                    {finalScore === 100 ? '¬°Enhorabuena, puntuaci√≥n m√°xima!' : '¬°Buen trabajo! Sigue practicando'}
                                </p>
                                <div className="btn-group">
                                    <button className="btn" style={{ backgroundColor: '#f59e42' }} onClick={() => { playTap(); setScreen('start'); }}>Volver al men√∫</button>
                                    <button className="btn btn-primary" onClick={() => startGame(true)}>Entrenamiento infinito</button>
                                </div>
                                <p className="credit">Created by Manuel J. Ventura</p>
                                <img src="https://github.com/ManuelVS8/Efectos_audio/blob/1e2a36cdd1f8bedcb578a30f5ec5cc8f21c287fe/Siurot.png?raw=true" alt="Logo del colegio" className="school-logo" />
                            </div>
                            {finalScore === 100 && <Confetti />}
                        </div>
                    )}
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>